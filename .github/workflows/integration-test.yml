name: Integration Test

on:
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  trigger-consumer-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ ê³„ì† ì‹¤í–‰
      matrix:
        repo:
          - sample-cpp-repo
          - sample-java-repo
          - sample-binary-repo
          - sample-multi-lang-repo
    steps:
      - name: Trigger CI in ${{ matrix.repo }}
        run: |
          echo "Triggering CI workflow in ${{ matrix.repo }}..."
          gh workflow run ci.yml \
            --repo youngseokyoon/${{ matrix.repo }} \
            --ref main
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow to start
        run: sleep 10
      
      - name: Get latest workflow run
        id: get-run
        run: |
          RUN_ID=$(gh run list \
            --repo youngseokyoon/${{ matrix.repo }} \
            --workflow=ci.yml \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest run ID: $RUN_ID"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow completion
        run: |
          echo "Waiting for workflow run ${{ steps.get-run.outputs.run_id }} to complete..."
          gh run watch ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --exit-status
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check workflow result
        run: |
          STATUS=$(gh run view ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --json conclusion \
            --jq '.conclusion')
          
          echo "Workflow status: $STATUS"
          
          if [ "$STATUS" != "success" ]; then
            echo "âŒ CI failed in ${{ matrix.repo }}"
            exit 1
          fi
          
          echo "âœ… CI passed in ${{ matrix.repo }}"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
  
  integration-summary:
    if: always()  # ì‹¤íŒ¨í•´ë„ í•­ìƒ ì‹¤í–‰
    needs: trigger-consumer-tests
    runs-on: ubuntu-latest
    steps:
      - name: Collect results
        id: results
        run: |
          echo "ğŸ“Š Collecting integration test results..."
          
          # Matrix ê²°ê³¼ í™•ì¸
          RESULT="${{ needs.trigger-consumer-tests.result }}"
          
          if [ "$RESULT" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi
      
      - name: Post result to PR
        if: github.event_name == 'pull_request'
        run: |
          if [ "${{ steps.results.outputs.status }}" = "success" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "âœ… **Integration Test Passed**

All consumer repositories (sample-cpp-repo, sample-java-repo, sample-binary-repo, sample-multi-lang-repo) passed their CI tests." \
              --repo ${{ github.repository }}
          else
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "âŒ **Integration Test Failed**

Some consumer repositories failed. Check the workflow logs for details." \
              --repo ${{ github.repository }}
          fi
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check final status
        run: |
          echo "ğŸ“Š Integration Test Results Summary"
          echo "===================================="
          
          if [ "${{ steps.results.outputs.status }}" = "success" ]; then
            echo "ğŸ‰ All consumer repositories passed CI tests!"
            echo "âœ… Safe to merge this PR"
          else
            echo "âŒ Some tests failed - review the matrix results above"
            echo "âš ï¸  Please fix issues before merging"
            exit 1
          fi
