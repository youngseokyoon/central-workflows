name: Integration Test

on:
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  trigger-consumer-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # ÌïòÎÇò Ïã§Ìå®Ìï¥ÎèÑ ÎÇòÎ®∏ÏßÄ Í≥ÑÏÜç Ïã§Ìñâ
      matrix:
        repo:
          - sample-cpp-repo
          - sample-java-repo
          - sample-binary-repo
          - sample-multi-lang-repo
    steps:
      - name: Trigger CI in ${{ matrix.repo }}
        run: |
          echo "Triggering CI workflow in ${{ matrix.repo }}..."
          gh workflow run ci.yml \
            --repo youngseokyoon/${{ matrix.repo }} \
            --ref main
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow to start
        run: sleep 10
      
      - name: Get latest workflow run
        id: get-run
        run: |
          RUN_ID=$(gh run list \
            --repo youngseokyoon/${{ matrix.repo }} \
            --workflow=ci.yml \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest run ID: $RUN_ID"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow completion
        run: |
          echo "Waiting for workflow run ${{ steps.get-run.outputs.run_id }} to complete..."
          gh run watch ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --exit-status
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check workflow result
        run: |
          STATUS=$(gh run view ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --json conclusion \
            --jq '.conclusion')
          
          echo "Workflow status: $STATUS"
          
          if [ "$STATUS" != "success" ]; then
            echo "‚ùå CI failed in ${{ matrix.repo }}"
            exit 1
          fi
          
          echo "‚úÖ CI passed in ${{ matrix.repo }}"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
  
  integration-summary:
    if: always()  # Ïã§Ìå®Ìï¥ÎèÑ Ìï≠ÏÉÅ Ïã§Ìñâ
    needs: trigger-consumer-tests
    runs-on: ubuntu-latest
    steps:
      - name: Collect results
        id: results
        run: |
          echo "üìä Collecting integration test results..."
          
          # Matrix Í≤∞Í≥º ÌôïÏù∏
          RESULT="${{ needs.trigger-consumer-tests.result }}"
          
          if [ "$RESULT" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          fi
      
      - name: Post result to PR
        if: github.event_name == 'pull_request'
        run: |
          if [ "${{ steps.results.outputs.status }}" = "success" ]; then
            MESSAGE="‚úÖ **Integration Test Passed**

All consumer repositories (sample-cpp-repo, sample-java-repo, sample-binary-repo, sample-multi-lang-repo) passed their CI tests."
          else
            MESSAGE="‚ùå **Integration Test Failed**

Some consumer repositories failed. Check the workflow logs for details."
          fi
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$MESSAGE" \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check final status
        run: |
          echo "üìä Integration Test Results Summary"
          echo "===================================="
          
          if [ "${{ steps.results.outputs.status }}" = "success" ]; then
            echo "üéâ All consumer repositories passed CI tests!"
            echo "‚úÖ Safe to merge this PR"
          else
            echo "‚ùå Some tests failed - review the matrix results above"
            echo "‚ö†Ô∏è  Please fix issues before merging"
            exit 1
          fi
