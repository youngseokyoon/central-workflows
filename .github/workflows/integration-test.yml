name: Integration Test

on:
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  trigger-consumer-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # ÌïòÎÇò Ïã§Ìå®Ìï¥ÎèÑ ÎÇòÎ®∏ÏßÄ Í≥ÑÏÜç Ïã§Ìñâ
      matrix:
        repo:
          - sample-cpp-repo
          - sample-java-repo
          - sample-binary-repo
          - sample-multi-lang-repo
    steps:
      - name: Trigger CI in ${{ matrix.repo }}
        run: |
          echo "Triggering CI workflow in ${{ matrix.repo }}..."
          gh workflow run ci.yml \
            --repo youngseokyoon/${{ matrix.repo }} \
            --ref main
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow to start
        run: sleep 10
      
      - name: Get latest workflow run
        id: get-run
        run: |
          RUN_ID=$(gh run list \
            --repo youngseokyoon/${{ matrix.repo }} \
            --workflow=ci.yml \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest run ID: $RUN_ID"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Wait for workflow completion
        run: |
          echo "Waiting for workflow run ${{ steps.get-run.outputs.run_id }} to complete..."
          gh run watch ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --exit-status
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check workflow result
        run: |
          STATUS=$(gh run view ${{ steps.get-run.outputs.run_id }} \
            --repo youngseokyoon/${{ matrix.repo }} \
            --json conclusion \
            --jq '.conclusion')
          
          echo "Workflow status: $STATUS"
          
          if [ "$STATUS" != "success" ]; then
            echo "‚ùå CI failed in ${{ matrix.repo }}"
            exit 1
          fi
          
          echo "‚úÖ CI passed in ${{ matrix.repo }}"
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
  
  integration-summary:
    if: always()  # Ïã§Ìå®Ìï¥ÎèÑ Ìï≠ÏÉÅ Ïã§Ìñâ
    needs: trigger-consumer-tests
    runs-on: ubuntu-latest
    steps:
      - name: Collect results
        id: results
        run: |
          echo "üìä Collecting integration test results..."
          
          # Matrix Í≤∞Í≥º ÌôïÏù∏
          RESULT="${{ needs.trigger-consumer-tests.result }}"
          
          if [ "$RESULT" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          fi
      
      - name: Create PR comment
        if: github.event_name == 'pull_request'
        run: |
          # Generate report
          cat > report.md << 'EOF'
          ## ${{ steps.results.outputs.emoji }} Integration Test Results
          
          **Status**: ${{ needs.trigger-consumer-tests.result }}
          
          ### Consumer Repository Tests
          
          | Repository | Status |
          |------------|--------|
          | `sample-cpp-repo` | ${{ needs.trigger-consumer-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | `sample-java-repo` | ${{ needs.trigger-consumer-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | `sample-binary-repo` | ${{ needs.trigger-consumer-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          | `sample-multi-lang-repo` | ${{ needs.trigger-consumer-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
          
          ---
          
          <details>
          <summary>‚ÑπÔ∏è What was tested?</summary>
          
          This PR triggered actual CI workflows in all consumer repositories to verify compatibility.
          
          - Each repository's **real CI workflow** was executed
          - Tests ran against the `main` branch of each consumer repo
          - All workflows used the **current state** of central-workflows
          
          </details>
          
          ${{ steps.results.outputs.status == 'success' && '### ‚úÖ Safe to Merge\n\nAll consumer repositories passed their CI tests with these workflow changes!' || '### ‚ö†Ô∏è Action Required\n\nSome consumer repositories failed. Please review the test results above and fix any issues before merging.' }}
          
          ---
          *ü§ñ Automated by Integration Test workflow*
          EOF
          
          # Post comment to PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file report.md \
            --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.CI_TOKEN }}
      
      - name: Check final status
        run: |
          echo "üìä Integration Test Results Summary"
          echo "===================================="
          
          if [ "${{ steps.results.outputs.status }}" = "success" ]; then
            echo "üéâ All consumer repositories passed CI tests!"
            echo "‚úÖ Safe to merge this PR"
          else
            echo "‚ùå Some tests failed - review the matrix results above"
            echo "‚ö†Ô∏è  Please fix issues before merging"
            exit 1
          fi
